<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport de conformite — {{ system_name }}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; color: #1a1a1a; line-height: 1.6; }
        h1 { border-bottom: 3px solid #2563eb; padding-bottom: 0.5rem; }
        h2 { color: #1e40af; margin-top: 2rem; }
        .meta { color: #6b7280; font-size: 0.9rem; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.85rem; font-weight: 600; }
        .badge-ok { background: #dcfce7; color: #166534; }
        .badge-warn { background: #fef9c3; color: #854d0e; }
        .badge-fail { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        th, td { border: 1px solid #e5e7eb; padding: 0.5rem 0.75rem; text-align: left; }
        th { background: #f9fafb; font-weight: 600; }
        .progress-bar { background: #e5e7eb; border-radius: 4px; overflow: hidden; height: 1.25rem; }
        .progress-fill { height: 100%; border-radius: 4px; text-align: center; color: white; font-size: 0.75rem; line-height: 1.25rem; }
        .pct-high { background: #22c55e; }
        .pct-mid { background: #f59e0b; }
        .pct-low { background: #ef4444; }
        footer { margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; color: #9ca3af; font-size: 0.8rem; }
    </style>
</head>
<body>
    <h1>Rapport de conformite AI Act</h1>
    <p class="meta">Systeme : <strong>{{ system_name }}</strong> | Date : {{ timestamp }} | ATUM Audit v{{ version }}</p>

    <h2>Statut global</h2>
    <table>
        <tr>
            <th>Niveau de risque</th>
            <td><span class="badge {% if risk_level in ['HighRisk', 'Unacceptable'] %}badge-fail{% elif risk_level == 'LimitedRisk' %}badge-warn{% else %}badge-ok{% endif %}">{{ risk_level }}</span></td>
        </tr>
        <tr>
            <th>Conformite</th>
            <td><span class="badge {% if compliance_status == 'Compliant' %}badge-ok{% elif compliance_status == 'NonCompliant' %}badge-fail{% else %}badge-warn{% endif %}">{{ compliance_status }}</span></td>
        </tr>
        <tr>
            <th>Phase</th>
            <td><span class="badge badge-info">{{ lifecycle_phase }}</span></td>
        </tr>
        {% if validation %}
        <tr>
            <th>Validation SHACL</th>
            <td><span class="badge {% if validation.conforms %}badge-ok{% else %}badge-fail{% endif %}">{% if validation.conforms %}Conforme{% else %}{{ validation.stats.errors }} erreur(s), {{ validation.stats.warnings }} avertissement(s){% endif %}</span></td>
        </tr>
        {% endif %}
    </table>

    {% if annex_iv %}
    <h2>Documentation technique (Annexe IV)</h2>
    <p>Completude globale : <strong>{{ annex_iv.completeness_pct }}%</strong></p>
    <table>
        <thead>
            <tr><th>Point</th><th>Article</th><th>Completude</th><th>Champs manquants</th></tr>
        </thead>
        <tbody>
        {% for pt in annex_iv.points %}
            <tr>
                <td>{{ pt.label }}</td>
                <td>{{ pt.article }}</td>
                <td>
                    <div class="progress-bar">
                        <div class="progress-fill {% if pt.pct >= 80 %}pct-high{% elif pt.pct >= 40 %}pct-mid{% else %}pct-low{% endif %}" style="width: {{ pt.pct }}%">{{ pt.pct|round(0)|int }}%</div>
                    </div>
                </td>
                <td>{% if pt.missing %}{{ pt.missing|join(', ') }}{% else %}-{% endif %}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% if violations %}
    <h2>Violations SHACL</h2>
    <table>
        <thead>
            <tr><th>Severite</th><th>Noeud</th><th>Propriete</th><th>Message</th></tr>
        </thead>
        <tbody>
        {% for v in violations %}
            <tr>
                <td><span class="badge {% if v.severity == 'Violation' %}badge-fail{% else %}badge-warn{% endif %}">{{ v.severity }}</span></td>
                <td>{{ v.focus_node }}</td>
                <td>{{ v.path }}</td>
                <td>{{ v.message }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% if incidents %}
    <h2>Incidents (Art. 62)</h2>
    <table>
        <thead>
            <tr><th>ID</th><th>Description</th><th>Severite</th><th>Date</th><th>Deadline</th></tr>
        </thead>
        <tbody>
        {% for inc in incidents %}
            <tr>
                <td>{{ inc.incident_id }}</td>
                <td>{{ inc.description }}</td>
                <td><span class="badge {% if inc.severity == 'SeverityCritical' %}badge-fail{% else %}badge-warn{% endif %}">{{ inc.severity }}</span></td>
                <td>{{ inc.timestamp }}</td>
                <td>{{ inc.deadline }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% if models %}
    <h2>Lineage des modeles (Art. 11)</h2>
    <table>
        <thead>
            <tr><th>Version</th><th>Date entrainement</th><th>Metriques</th></tr>
        </thead>
        <tbody>
        {% for m in models %}
            <tr>
                <td>{{ m.version_tag }}</td>
                <td>{{ m.trained_at }}</td>
                <td>{{ m.metrics }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <footer>
        Genere par ATUM Audit Agent — Reg. (EU) 2024/1689
    </footer>
</body>
</html>
